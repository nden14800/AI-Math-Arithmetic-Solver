<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI数学・算数ソルバー</title>

    <!-- Google Fonts: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- KaTeX: v0.16.22 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>

    <style>
        :root {
            /* Wolfram Alpha Inspired Colors */
            --wa-orange: #f96932;       /* Primary Action Color */
            --wa-orange-hover: #e05520;
            --wa-bg: #ffffff;           /* Main Background */
            --wa-panel-bg: #ffffff;
            --wa-border: #e0e0e0;       /* Subtle Border */
            --wa-text-main: #222222;
            --wa-text-sub: #666666;
            --wa-input-bg: #ffffff;
            --wa-shadow: 0 1px 4px rgba(0,0,0,0.1);
            
            /* Dark Mode Variables */
            --dark-bg: #181818;
            --dark-panel-bg: #242424;
            --dark-border: #333333;
            --dark-text-main: #eeeeee;
            --dark-text-sub: #aaaaaa;
            --dark-input-bg: #2b2b2b;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--wa-bg);
            color: var(--wa-text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--dark-bg);
                color: var(--dark-text-main);
            }
        }

        .container {
            width: 100%;
            max-width: 850px;
            padding: 2rem 1rem;
            box-sizing: border-box;
        }

        /* Header Area */
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            margin-top: 2rem;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
            color: var(--wa-text-main);
        }
        
        .header h1 span {
            color: var(--wa-orange); /* Highlight color like the logo */
        }
        
        @media (prefers-color-scheme: dark) {
            .header h1 { color: var(--dark-text-main); }
        }

        /* Input Area - Wolfram Style: Large, clean, with an equal/search button */
        .input-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 3rem;
        }

        .input-area {
            display: flex;
            align-items: center;
            background-color: var(--wa-input-bg);
            border: 1px solid var(--wa-border);
            border-radius: 8px; /* Slightly rounded, not full pill */
            box-shadow: var(--wa-shadow);
            padding: 0.5rem;
            transition: box-shadow 0.2s, border-color 0.2s;
        }

        .input-area:focus-within {
            box-shadow: 0 2px 8px rgba(249, 105, 50, 0.25);
            border-color: var(--wa-orange);
        }

        @media (prefers-color-scheme: dark) {
            .input-area {
                background-color: var(--dark-input-bg);
                border-color: var(--dark-border);
            }
            .input-area:focus-within {
                border-color: var(--wa-orange);
            }
        }

        #problem-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            border: none;
            background: transparent;
            color: inherit;
            font-family: inherit;
        }
        #problem-input:focus {
            outline: none;
        }

        #submit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: transparent;
            color: var(--wa-orange);
            transition: background-color 0.2s, color 0.2s;
        }
        
        #submit-btn:hover {
            background-color: rgba(249, 105, 50, 0.1);
        }
        
        /* Wolfram often uses an "=" sign, but we'll use a Search/Equal hybrid or simple Search */
        #submit-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* Results Area */
        #results-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Result Cards - "Normal Ordinary Border" */
        .result-card {
            background-color: var(--wa-panel-bg);
            border: 1px solid var(--wa-border);
            border-radius: 4px; /* Wolfram uses sharper corners generally */
            padding: 1.5rem;
            position: relative;
        }

        @media (prefers-color-scheme: dark) {
            .result-card {
                background-color: var(--dark-panel-bg);
                border-color: var(--dark-border);
            }
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--wa-text-sub);
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        
        @media (prefers-color-scheme: dark) {
            .card-header {
                color: var(--dark-text-sub);
                border-bottom-color: #333;
            }
        }

        .card-header svg {
            width: 18px;
            height: 18px;
            fill: var(--wa-orange); /* Brand color icons */
        }

        .result-content, .steps-content {
            line-height: 1.8;
            font-size: 1.05rem;
            color: var(--wa-text-main);
        }
        @media (prefers-color-scheme: dark) {
            .result-content, .steps-content {
                color: var(--dark-text-main);
            }
        }

        /* Steps Button */
        .steps-btn {
            margin-top: 1.5rem;
            padding: 0.6rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 500;
            border: 1px solid var(--wa-orange);
            color: var(--wa-orange);
            background-color: transparent;
            border-radius: 20px; /* Pill shape */
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .steps-btn:hover {
            background-color: var(--wa-orange);
            color: white;
        }
        .steps-btn:disabled {
            border-color: var(--wa-border);
            color: var(--wa-text-sub);
            cursor: not-allowed;
            background-color: transparent;
        }

        /* Disclaimer */
        .card-footer {
            margin-top: 1.5rem;
            padding-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--wa-text-sub);
            text-align: right;
        }
        @media (prefers-color-scheme: dark) {
            .card-footer { color: var(--dark-text-sub); }
        }

        /* Loader */
        .loader-container {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .loader {
            width: 40px;
            height: 40px;
            animation: rotate 1s linear infinite;
        }
        .loader .path {
            stroke: var(--wa-orange);
            stroke-linecap: round;
            stroke-dasharray: 89 150;
            stroke-dashoffset: 0;
        }
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <!-- タイトルを少しWolfram風に。spanで色分け -->
            <h1>AI <span>Math</span> Solver</h1>
        </header>

        <main>
            <div class="input-wrapper">
                <div class="input-area">
                    <input type="text" id="problem-input" placeholder="計算したい式や数学の質問を入力してください...">
                    <button id="submit-btn" title="計算">
                        <!-- Bootstrap Icon: bi-search (または bi-arrow-return-right) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="results-container">
                <!-- AIの回答はここに表示されます -->
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const problemInput = document.getElementById('problem-input');
            const submitBtn = document.getElementById('submit-btn');
            const resultsContainer = document.getElementById('results-container');

            // --- ★★★ 重要 ★★★ ---
            // Cloudflare WorkerのURLを設定します。
            // ご自身のWorkerのURLに書き換えてください。
            const WORKER_URL = 'https://math-solver-proxy.nden14800.workers.dev'; 

            // --- KaTeX Auto-render settings ---
            const renderMath = (element) => {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            };

            // --- Main Logic ---
            const showLoader = () => {
                resultsContainer.innerHTML = `
                    <div class="loader-container" style="display: flex;">
                        <svg class="loader" viewBox="0 0 50 50">
                            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="3.5"></circle>
                        </svg>
                    </div>`;
            };
            
            const showError = (message) => {
                resultsContainer.innerHTML = `
                <div class="result-card" style="border-left: 4px solid #dc3545;">
                    <div class="card-header" style="color: #dc3545;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
                        </svg>
                        エラーが発生しました
                    </div>
                    <p>${message}</p>
                </div>`;
            };

            const callApiViaWorker = async (prompt) => {
                if (!WORKER_URL || WORKER_URL.includes('YOUR_USERNAME')) {
                    throw new Error('Cloudflare WorkerのURLが設定されていません。コードを編集してください。');
                }

                try {
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || `サーバーからのエラー: ${response.status}`);
                    }
                    
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        return text;
                    } else {
                        const finishReason = data?.candidates?.[0]?.finishReason;
                        let errorMessage = 'AIが回答を生成できませんでした。';
                        if (finishReason === 'SAFETY') {
                            errorMessage += ' 安全性の設定により、回答がブロックされた可能性があります。';
                        } else {
                            errorMessage += ` (理由: ${finishReason})`;
                        }
                        throw new Error(errorMessage);
                    }

                } catch (error) {
                    console.error('API呼び出しエラー:', error);
                    if (error instanceof TypeError) {
                        throw new Error('ネットワークエラー、またはCORS設定に問題がある可能性があります。');
                    }
                    throw error;
                }
            };
            
            const handleSubmission = async () => {
                const problem = problemInput.value.trim();
                if (!problem) return;

                showLoader();
                
                const prompt = `以下の数学や算数に関する質問に答えてください。答えと、必要であれば簡単な解説を日本語で記述してください。数式は必ずKaTeXの形式($$...$$ や $...$)で出力してください。\n\n質問: ${problem}`;
                
                try {
                    const resultText = await callApiViaWorker(prompt);
                    // UI: Wolfram風 "Pod" スタイル
                    resultsContainer.innerHTML = `
                        <div class="result-card" id="initial-answer-card">
                            <div class="card-header">
                                <!-- Bootstrap Icon: bi-lightbulb -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16">
                                  <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l.224.447a1 1 0 0 1 .894.553l.224.447a.5.5 0 0 1 0 1h-8a.5.5 0 0 1 0-1l.224-.447a1 1 0 0 1 .894-.553l.224-.447a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.31l-.762-1.77a2 2 0 0 0-.453-.62A5.97 5.97 0 0 1 2 6m6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1"/>
                                </svg>
                                <span>AI による解答</span>
                            </div>
                            <div class="result-content">${resultText}</div>
                            
                            <!-- 解説ボタン -->
                            <button class="steps-btn" id="show-steps-btn">
                                <!-- Bootstrap Icon: bi-list-ol -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ol" viewBox="0 0 16 16">
                                  <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5"/>
                                  <path d="M1.713 11.865v-.474H2c.217 0 .363-.137.363-.317 0-.185-.158-.31-.361-.31-.223 0-.367.152-.373.31h-.59c.016-.467.373-.787.986-.787.588-.002.954.291.957.703a.595.595 0 0 1-.492.594v.033a.615.615 0 0 1 .569.631c.003.533-.502.8-1.051.8-.656 0-1-.37-1.008-.794h.582c.008.178.186.306.422.309.254 0 .424-.145.422-.35-.002-.195-.155-.348-.414-.348h-.3zm-.004-4.699h-.604v-.035c0-.408.295-.844.958-.844.583 0 .96.326.96.756 0 .389-.257.617-.476.848l-.537.572v.03h1.054V9H1.143v-.395l.957-.99c.138-.142.293-.304.293-.508 0-.18-.147-.32-.342-.321-.244 0-.364.187-.37.412l-.004.042zm-1.296-.697h1.055v4h-1.055v-4z"/>
                                </svg>
                                AI によるステップごとの解説
                            </button>

                            <footer class="card-footer">
                                AIの回答には間違いが含まれている場合があります。
                            </footer>
                        </div>
                    `;
                    renderMath(resultsContainer);
                    document.getElementById('show-steps-btn').addEventListener('click', () => getStepByStep(problem, resultText));
                } catch (error) {
                    showError(error.message);
                }
            };
            
            const getStepByStep = async (problem, initialAnswer) => {
                const stepsBtn = document.getElementById('show-steps-btn');
                stepsBtn.disabled = true;
                stepsBtn.innerHTML = `
                    <span style="width: 1rem; height: 1rem; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; display: inline-block; animation: rotate 1s linear infinite;"></span>
                    解説を生成中...`;

                const loaderContainer = document.createElement('div');
                loaderContainer.id = 'steps-loader-container';
                // 既存のカードの下にローダーは追加せず、ボタンのステータスで表現しますが、
                // リクエストのUXフローに合わせて下にカードが出る前の待機場所を作ります
                loaderContainer.innerHTML = `
                    <div class="loader-container" style="display: flex;">
                        <svg class="loader" viewBox="0 0 50 50">
                            <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="3.5"></circle>
                        </svg>
                    </div>`;
                document.getElementById('initial-answer-card').insertAdjacentElement('afterend', loaderContainer);

                const prompt = `以下の数学や算数に関する質問とそのAIによる回答について、ステップごとの詳しい解説を作成してください。\n\n質問: ${problem}\n\nAIによる回答: ${initialAnswer}\n\n解説は日本語で、数式はKaTeX形式で出力してください。`;
                
                try {
                    const stepsText = await callApiViaWorker(prompt);
                    const stepsCard = document.createElement('div');
                    stepsCard.className = 'result-card';
                    // "AI によるステップごとの解説"
                    stepsCard.innerHTML = `
                        <div class="card-header">
                           <!-- Bootstrap Icon: bi-layers -->
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-layers" viewBox="0 0 16 16">
                              <path d="M8.235 1.559a.5.5 0 0 0-.47 0l-7.5 4a.5.5 0 0 0 0 .882L3.188 8 .264 9.559a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882L12.813 8l2.922-1.559a.5.5 0 0 0 0-.882zm3.515 7.008L14.438 10 8 13.433 1.562 10 4.25 8.567l3.515 1.874a.5.5 0 0 0 .47 0zM8 9.433 1.562 6 8 2.567 14.438 6z"/>
                           </svg>
                           <span>AI によるステップごとの解説</span>
                        </div>
                        <div class="steps-content">${stepsText}</div>
                        <footer class="card-footer">
                            AIの回答には間違いが含まれている場合があります。
                        </footer>
                    `;
                    document.getElementById('initial-answer-card').insertAdjacentElement('afterend', stepsCard);
                    renderMath(stepsCard);
                    
                    // ボタンを非表示にする（解説済みのため）
                    stepsBtn.style.display = 'none';
                } catch (error) {
                    alert(`解説の生成に失敗しました: ${error.message}`);
                    stepsBtn.disabled = false;
                    stepsBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ol" viewBox="0 0 16 16">
                           <path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5"/>
                           <path d="M1.713 11.865v-.474H2c.217 0 .363-.137.363-.317 0-.185-.158-.31-.361-.31-.223 0-.367.152-.373.31h-.59c.016-.467.373-.787.986-.787.588-.002.954.291.957.703a.595.595 0 0 1-.492.594v.033a.615.615 0 0 1 .569.631c.003.533-.502.8-1.051.8-.656 0-1-.37-1.008-.794h.582c.008.178.186.306.422.309.254 0 .424-.145.422-.35-.002-.195-.155-.348-.414-.348h-.3zm-.004-4.699h-.604v-.035c0-.408.295-.844.958-.844.583 0 .96.326.96.756 0 .389-.257.617-.476.848l-.537.572v.03h1.054V9H1.143v-.395l.957-.99c.138-.142.293-.304.293-.508 0-.18-.147-.32-.342-.321-.244 0-.364.187-.37.412l-.004.042zm-1.296-.697h1.055v4h-1.055v-4z"/>
                        </svg>
                        AI によるステップごとの解説`;
                } finally {
                    const existingLoader = document.getElementById('steps-loader-container');
                    if (existingLoader) {
                        existingLoader.remove();
                    }
                }
            };

            submitBtn.addEventListener('click', handleSubmission);
            problemInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSubmission();
                }
            });
        });
    </script>
</body>
</html>
